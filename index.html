<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office TV Kiosk</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            overflow: hidden;
        }

        .kiosk-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        /* Slide styling */
        .slide {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        .slide.active {
            opacity: 1;
            z-index: 1;
        }

        /* Image slide styling */
        .slide.image-slide {
            background-position: center;
            background-repeat: no-repeat;
        }

        .slide.image-slide.fit-cover {
            background-size: cover;
        }

        .slide.image-slide.fit-contain {
            background-size: contain;
        }

        .slide.image-slide.fit-fill {
            background-size: 100% 100%;
        }

        .slide.image-slide.fit-actual {
            background-size: auto;
        }

        .slide.image-slide::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3), transparent 20%, transparent 80%, rgba(0,0,0,0.3));
        }

        /* Power BI slide - full screen iframe */
        .slide.powerbi-slide {
            background: #f3f2f1;
            padding: 0;
        }

        .slide.powerbi-slide iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Progress bar */
        .progress-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(to right, #0078d4, #50e6ff);
            width: 0%;
            transition: width linear;
            z-index: 1000;
            box-shadow: 0 0 10px rgba(0, 120, 212, 0.5);
        }

        /* Slide counter */
        .slide-counter {
            position: fixed;
            top: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Date and Time display */
        .datetime-display {
            position: fixed;
            top: 30px;
            left: 30px;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 15px 25px;
            border-radius: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .datetime-display .time {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .datetime-display .date {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Settings button */
        .settings-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: rgba(0, 120, 212, 0.9);
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 120, 212, 0.4);
        }

        .settings-button:hover {
            background: rgba(0, 120, 212, 1);
            transform: rotate(90deg) scale(1.1);
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -700px;
            width: 700px;
            height: 100vh;
            background: #fff;
            z-index: 2000;
            transition: right 0.3s ease;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            background: linear-gradient(135deg, #0078d4, #50e6ff);
            color: #fff;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h2 {
            font-size: 24px;
            font-weight: 600;
        }

        .close-settings {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .close-settings:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .settings-section {
            margin-bottom: 35px;
        }

        .settings-section h3 {
            font-size: 16px;
            font-weight: 600;
            color: #0078d4;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            font-family: 'Segoe UI', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #0078d4;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }

        .slide-item {
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .slide-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .slide-item-header h4 {
            font-size: 14px;
            font-weight: 600;
            color: #0078d4;
        }

        .remove-slide {
            background: #e81123;
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .remove-slide:hover {
            background: #c50f1f;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #0078d4;
            color: #fff;
        }

        .btn-primary:hover {
            background: #106ebe;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #107c10;
            color: #fff;
        }

        .btn-success:hover {
            background: #0e6b0e;
        }

        .slides-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .settings-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .success-message {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #107c10;
            color: #fff;
            padding: 15px 30px;
            border-radius: 8px;
            z-index: 3000;
            display: none;
            animation: slideDown 0.3s ease-out;
            box-shadow: 0 4px 20px rgba(16, 124, 16, 0.4);
        }

        .success-message.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                transform: translate(-50%, -100px);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .export-import-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        textarea.config-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #0078d4;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #333;
        }

        .info-box strong {
            color: #0078d4;
        }

        .warning-box {
            background: #fff4ce;
            border-left: 4px solid #f59b00;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #333;
        }

        .warning-box strong {
            color: #f59b00;
        }

        .error-box {
            background: #fde7e9;
            border-left: 4px solid #e81123;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #333;
        }

        .error-box strong {
            color: #e81123;
        }

        .help-link {
            color: #0078d4;
            text-decoration: underline;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .settings-panel {
                width: 100%;
                right: -100%;
            }
            
            .datetime-display .time {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="kiosk-container" id="kioskContainer"></div>
    <div class="progress-bar" id="progressBar"></div>
    <div class="slide-counter" id="slideCounter">1 / 1</div>
    <div class="datetime-display">
        <div class="time" id="timeDisplay">00:00</div>
        <div class="date" id="dateDisplay">Monday, January 1, 2024</div>
    </div>
    <button class="settings-button" id="settingsButton" title="Open Settings">‚öô</button>
    <div class="settings-overlay" id="settingsOverlay"></div>

    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2>Kiosk Settings</h2>
            <button class="close-settings" id="closeSettings">√ó</button>
        </div>
        
        <div class="settings-content">
            <div class="settings-section">
                <h3>General Settings</h3>
                
                <div class="form-group">
                    <label>Default Slide Duration (seconds)</label>
                    <input type="number" id="slideDuration" min="5" max="300" value="15">
                    <small>How long to show each image slide (5-300 seconds)</small>
                </div>

                <div class="form-group">
                    <label>Power BI Duration (seconds)</label>
                    <input type="number" id="powerBiDuration" min="10" max="600" value="30">
                    <small>How long to show Power BI reports (10-600 seconds)</small>
                </div>

                <div class="form-group">
                    <label>Auto-Refresh (hours)</label>
                    <input type="number" id="autoRefreshHours" min="1" max="168" value="24">
                    <small>Automatically reload page every X hours (1-168)</small>
                </div>

                <div class="form-group">
                    <label>Default Image Fit</label>
                    <select id="defaultImageFit">
                        <option value="cover">Cover (fill screen, may crop)</option>
                        <option value="contain">Contain (show full image, may have bars)</option>
                        <option value="fill">Fill (stretch to fit)</option>
                        <option value="actual">Actual Size (no scaling)</option>
                    </select>
                    <small>How images should fit on screen by default</small>
                </div>
            </div>

            <div class="settings-section">
                <h3>Slides</h3>
                
                <div class="error-box">
                    <strong>‚ö†Ô∏è IMPORTANT: Power BI Authentication</strong><br><br>
                    Power BI reports require one of these methods:<br><br>
                    
                    <strong>Option 1: Publish to Web (Anonymous - Recommended for TVs)</strong><br>
                    ‚Ä¢ Makes report publicly accessible (anyone with link)<br>
                    ‚Ä¢ No login required<br>
                    ‚Ä¢ URL format: <code>https://app.powerbi.com/view?r=XXXXX</code><br>
                    ‚Ä¢ <span class="help-link" onclick="showPublishToWebHelp()">How to publish to web ‚Üí</span><br><br>
                    
                    <strong>Option 2: Secure Embed (Requires Login)</strong><br>
                    ‚Ä¢ TV must be logged into Microsoft account<br>
                    ‚Ä¢ Account needs report access<br>
                    ‚Ä¢ Will prompt for login if not authenticated<br>
                    ‚Ä¢ URL format: <code>https://app.powerbi.com/reportEmbed?reportId=...</code><br><br>
                    
                    <strong>Option 3: Export as Image (No Authentication)</strong><br>
                    ‚Ä¢ Export Power BI report as image (PNG/JPG)<br>
                    ‚Ä¢ Upload to SharePoint<br>
                    ‚Ä¢ Add as regular image slide<br>
                    ‚Ä¢ <span class="help-link" onclick="showExportImageHelp()">How to export as image ‚Üí</span>
                </div>

                <div class="info-box">
                    <strong>Image URLs:</strong> Use full SharePoint URLs<br>
                    Example: <code>https://tenant.sharepoint.com/sites/site/library/image.jpg</code>
                </div>

                <div class="slides-list" id="slidesList"></div>

                <div class="button-group">
                    <button class="btn btn-secondary" id="addImageSlide">+ Add Image</button>
                    <button class="btn btn-secondary" id="addPowerBISlide">+ Add Power BI</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>Backup & Restore</h3>
                
                <div class="form-group">
                    <label>Export Configuration</label>
                    <textarea class="config-textarea" id="exportConfig" readonly></textarea>
                    <small>Copy this to backup your configuration</small>
                </div>

                <div class="form-group">
                    <label>Import Configuration</label>
                    <textarea class="config-textarea" id="importConfig" placeholder="Paste configuration JSON here..."></textarea>
                    <small>Paste a previously exported configuration</small>
                </div>

                <div class="export-import-group">
                    <button class="btn btn-secondary" id="copyExport">Copy to Clipboard</button>
                    <button class="btn btn-secondary" id="loadImport">Load Configuration</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="button-group">
                    <button class="btn btn-success" id="saveSettings">üíæ Save & Apply</button>
                    <button class="btn btn-secondary" id="resetSettings">Reset to Default</button>
                </div>
            </div>
        </div>
    </div>

    <div class="success-message" id="successMessage">Settings saved successfully!</div>

    <script>
        const DEFAULT_CONFIG = {
            slideDuration: 15000,
            powerBiDuration: 30000,
            autoRefreshHours: 24,
            defaultImageFit: 'contain',
            slides: [
                {
                    type: 'image',
                    url: 'https://via.placeholder.com/1920x1080/0078d4/ffffff?text=Office+TV+Kiosk+-+Click+Settings+to+Configure',
                    duration: 15000,
                    imageFit: 'contain'
                },
                {
                    type: 'image',
                    url: 'https://via.placeholder.com/1920x1080/50e6ff/000000?text=Add+SharePoint+Images+or+Export+Power+BI+as+Images',
                    duration: 15000,
                    imageFit: 'contain'
                }
            ]
        };

        function showPublishToWebHelp() {
            alert(`HOW TO PUBLISH POWER BI TO WEB:

1. Open your report in Power BI Service (app.powerbi.com)

2. Click "File" menu (top-left)

3. Click "Share" ‚Üí "Publish to web (public)"

4. Read the warning carefully:
   ‚ö†Ô∏è This makes your report PUBLIC
   ‚ö†Ô∏è Anyone with the link can view it
   ‚ö†Ô∏è No authentication required

5. Click "Create embed code"

6. Click "Publish"

7. Copy the LINK (not the iframe code)
   Format: https://app.powerbi.com/view?r=XXXXX

8. Paste this link in the Power BI slide settings

9. Test the link in a browser first!

NOTE: Only use this for non-sensitive data that can be public.`);
        }

        function showExportImageHelp() {
            alert(`HOW TO EXPORT POWER BI AS IMAGE:

METHOD 1: Export from Power BI Service
1. Open report in Power BI Service
2. Click "File" ‚Üí "Export" ‚Üí "Export this page"
3. Choose PNG or PDF format
4. Download the file
5. Upload to SharePoint
6. Get SharePoint URL
7. Add as Image slide (not Power BI slide)

METHOD 2: Screenshot
1. Open report in browser
2. Press F11 for fullscreen
3. Take screenshot (Print Screen)
4. Save as image
5. Upload to SharePoint
6. Use as Image slide

METHOD 3: Power BI Desktop
1. Open report in Power BI Desktop
2. Click on page
3. File ‚Üí Export ‚Üí Export as image
4. Choose format and quality
5. Save and upload to SharePoint

ADVANTAGES:
‚úÖ No login required
‚úÖ Works perfectly on TVs
‚úÖ No authentication issues
‚úÖ Faster loading

DISADVANTAGES:
‚ùå Not live/real-time data
‚ùå Must re-export when data updates
‚ùå Static snapshot only

RECOMMENDATION: Export weekly/monthly for TV displays`);
        }

        class StorageManager {
            static STORAGE_KEY = 'tv_kiosk_config';

            static save(config) {
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(config));
                    return true;
                } catch (error) {
                    console.error('Failed to save configuration:', error);
                    return false;
                }
            }

            static load() {
                try {
                    const data = localStorage.getItem(this.STORAGE_KEY);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('Failed to load configuration:', error);
                    return null;
                }
            }

            static clear() {
                try {
                    localStorage.removeItem(this.STORAGE_KEY);
                    return true;
                } catch (error) {
                    console.error('Failed to clear configuration:', error);
                    return false;
                }
            }
        }

        class SettingsUI {
            constructor(kiosk) {
                this.kiosk = kiosk;
                this.settingsPanel = document.getElementById('settingsPanel');
                this.settingsOverlay = document.getElementById('settingsOverlay');
                this.slidesList = document.getElementById('slidesList');
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('settingsButton').addEventListener('click', () => this.open());
                document.getElementById('closeSettings').addEventListener('click', () => this.close());
                this.settingsOverlay.addEventListener('click', () => this.close());
                document.getElementById('addImageSlide').addEventListener('click', () => this.addSlide('image'));
                document.getElementById('addPowerBISlide').addEventListener('click', () => this.addSlide('powerbi'));
                document.getElementById('saveSettings').addEventListener('click', () => this.save());
                document.getElementById('resetSettings').addEventListener('click', () => this.reset());
                document.getElementById('copyExport').addEventListener('click', () => this.copyExport());
                document.getElementById('loadImport').addEventListener('click', () => this.loadImport());

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.settingsPanel.classList.contains('open')) {
                        this.close();
                    }
                });
            }

            open() {
                this.loadCurrentSettings();
                this.settingsPanel.classList.add('open');
                this.settingsOverlay.classList.add('active');
                this.kiosk.pause();
            }

            close() {
                this.settingsPanel.classList.remove('open');
                this.settingsOverlay.classList.remove('active');
                this.kiosk.resume();
            }

            loadCurrentSettings() {
                const config = this.kiosk.config;
                document.getElementById('slideDuration').value = config.slideDuration / 1000;
                document.getElementById('powerBiDuration').value = config.powerBiDuration / 1000;
                document.getElementById('autoRefreshHours').value = config.autoRefreshHours;
                document.getElementById('defaultImageFit').value = config.defaultImageFit || 'contain';
                this.renderSlides(config.slides);
                this.updateExportConfig();
            }

            renderSlides(slides) {
                this.slidesList.innerHTML = '';
                slides.forEach((slide, index) => {
                    const slideItem = this.createSlideItem(slide, index);
                    this.slidesList.appendChild(slideItem);
                });
            }

            createSlideItem(slide, index) {
                const div = document.createElement('div');
                div.className = 'slide-item';
                div.dataset.index = index;

                const type = slide.type === 'powerbi' ? 'Power BI' : 'Image';
                const urlLabel = slide.type === 'powerbi' ? 'Power BI URL' : 'Image URL';
                
                const imageFitSection = slide.type === 'image' ? `
                    <div class="form-group">
                        <label>Image Fit</label>
                        <select class="slide-image-fit">
                            <option value="cover" ${slide.imageFit === 'cover' ? 'selected' : ''}>Cover (fill screen)</option>
                            <option value="contain" ${slide.imageFit === 'contain' || !slide.imageFit ? 'selected' : ''}>Contain (show full image)</option>
                            <option value="fill" ${slide.imageFit === 'fill' ? 'selected' : ''}>Fill (stretch)</option>
                            <option value="actual" ${slide.imageFit === 'actual' ? 'selected' : ''}>Actual Size</option>
                        </select>
                    </div>
                ` : '';

                div.innerHTML = `
                    <div class="slide-item-header">
                        <h4>Slide ${index + 1}: ${type}</h4>
                        <button class="remove-slide" data-index="${index}">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>${urlLabel}</label>
                        <input type="text" class="slide-url" value="${slide.url || slide.embedUrl || ''}" 
                               placeholder="${slide.type === 'powerbi' ? 'https://app.powerbi.com/view?r=... or reportEmbed?' : 'https://tenant.sharepoint.com/.../image.jpg'}">
                        <small>${slide.type === 'powerbi' ? 'Use Publish to Web URL or export report as image' : 'Full SharePoint URL'}</small>
                    </div>
                    ${imageFitSection}
                    <div class="form-group">
                        <label>Duration (seconds)</label>
                        <input type="number" class="slide-duration" value="${slide.duration / 1000}" min="5" max="600">
                    </div>
                `;

                div.querySelector('.remove-slide').addEventListener('click', () => this.removeSlide(index));
                return div;
            }

            addSlide(type) {
                const config = this.getCurrentConfig();
                const newSlide = {
                    type: type,
                    url: type === 'image' ? '' : undefined,
                    embedUrl: type === 'powerbi' ? '' : undefined,
                    duration: type === 'powerbi' ? 30000 : 15000,
                    imageFit: type === 'image' ? (config.defaultImageFit || 'contain') : undefined
                };
                config.slides.push(newSlide);
                this.renderSlides(config.slides);
                this.slidesList.scrollTop = this.slidesList.scrollHeight;
            }

            removeSlide(index) {
                const config = this.getCurrentConfig();
                config.slides.splice(index, 1);
                this.renderSlides(config.slides);
            }

            getCurrentConfig() {
                const config = {
                    slideDuration: parseInt(document.getElementById('slideDuration').value) * 1000,
                    powerBiDuration: parseInt(document.getElementById('powerBiDuration').value) * 1000,
                    autoRefreshHours: parseInt(document.getElementById('autoRefreshHours').value),
                    defaultImageFit: document.getElementById('defaultImageFit').value,
                    slides: []
                };

                const slideItems = this.slidesList.querySelectorAll('.slide-item');
                slideItems.forEach(item => {
                    const index = parseInt(item.dataset.index);
                    const originalSlide = this.kiosk.config.slides[index];
                    const url = item.querySelector('.slide-url').value.trim();
                    const duration = parseInt(item.querySelector('.slide-duration').value) * 1000;

                    if (url) {
                        const slide = {
                            type: originalSlide.type,
                            duration: duration
                        };

                        if (originalSlide.type === 'powerbi') {
                            slide.embedUrl = url;
                        } else {
                            slide.url = url;
                            const imageFitSelect = item.querySelector('.slide-image-fit');
                            slide.imageFit = imageFitSelect ? imageFitSelect.value : 'contain';
                        }

                        config.slides.push(slide);
                    }
                });

                return config;
            }

            save() {
                const config = this.getCurrentConfig();
                if (config.slides.length === 0) {
                    alert('Please add at least one slide!');
                    return;
                }
                if (StorageManager.save(config)) {
                    this.kiosk.updateConfig(config);
                    this.showSuccess('Settings saved successfully!');
                    setTimeout(() => this.close(), 1000);
                } else {
                    alert('Failed to save settings. Please check browser storage permissions.');
                }
            }

            reset() {
                if (confirm('Reset to default configuration? This will remove all your slides and settings.')) {
                    StorageManager.clear();
                    this.kiosk.updateConfig(DEFAULT_CONFIG);
                    this.loadCurrentSettings();
                    this.showSuccess('Settings reset to default');
                }
            }

            updateExportConfig() {
                const config = this.getCurrentConfig();
                document.getElementById('exportConfig').value = JSON.stringify(config, null, 2);
            }

            copyExport() {
                this.updateExportConfig();
                const textarea = document.getElementById('exportConfig');
                textarea.select();
                try {
                    document.execCommand('copy');
                    this.showSuccess('Configuration copied to clipboard!');
                } catch (err) {
                    navigator.clipboard.writeText(textarea.value).then(() => {
                        this.showSuccess('Configuration copied to clipboard!');
                    }).catch(() => {
                        alert('Please manually copy the configuration text');
                    });
                }
            }

            loadImport() {
                const importText = document.getElementById('importConfig').value.trim();
                if (!importText) {
                    alert('Please paste a configuration first!');
                    return;
                }
                try {
                    const config = JSON.parse(importText);
                    if (!config.slides || !Array.isArray(config.slides)) {
                        throw new Error('Invalid configuration format');
                    }
                    if (StorageManager.save(config)) {
                        this.kiosk.updateConfig(config);
                        this.loadCurrentSettings();
                        this.showSuccess('Configuration imported successfully!');
                        document.getElementById('importConfig').value = '';
                    }
                } catch (error) {
                    alert('Invalid configuration format: ' + error.message);
                }
            }

            showSuccess(message) {
                const successMsg = document.getElementById('successMessage');
                successMsg.textContent = message;
                successMsg.classList.add('show');
                setTimeout(() => successMsg.classList.remove('show'), 3000);
            }
        }

        class TVKiosk {
            constructor(config) {
                this.config = config;
                this.currentSlideIndex = 0;
                this.slides = [];
                this.slideTimeout = null;
                this.isTransitioning = false;
                this.isPaused = false;
                this.container = document.getElementById('kioskContainer');
                this.progressBar = document.getElementById('progressBar');
                this.slideCounter = document.getElementById('slideCounter');
                this.init();
            }

            init() {
                console.log('Initializing TV Kiosk...');
                this.createSlides();
                this.setupClock();
                this.startCarousel();
                this.setupAutoRefresh();
                this.setupKeyboardControls();
                this.setupWakeLock();
            }

            createSlides() {
                this.container.innerHTML = '';
                this.slides = [];
                
                this.config.slides.forEach((slideConfig, index) => {
                    const slide = document.createElement('div');
                    slide.className = 'slide';
                    slide.dataset.index = index;
                    
                    if (slideConfig.type === 'image') {
                        slide.classList.add('image-slide');
                        const imageFit = slideConfig.imageFit || this.config.defaultImageFit || 'contain';
                        slide.classList.add(`fit-${imageFit}`);
                        slide.style.backgroundImage = `url('${slideConfig.url}')`;
                        
                        const img = new Image();
                        img.src = slideConfig.url;
                        img.onerror = () => console.error(`Failed to load image: ${slideConfig.url}`);
                        
                    } else if (slideConfig.type === 'powerbi') {
                        slide.classList.add('powerbi-slide');
                        const iframe = document.createElement('iframe');
                        iframe.src = slideConfig.embedUrl;
                        iframe.allowFullscreen = true;
                        iframe.setAttribute('frameborder', '0');
                        iframe.setAttribute('allowtransparency', 'true');
                        slide.appendChild(iframe);
                    }
                    
                    this.container.appendChild(slide);
                    this.slides.push({ element: slide, config: slideConfig });
                });
                
                if (this.slides.length > 0) {
                    this.slides[0].element.classList.add('active');
                    this.updateCounter();
                }
                console.log(`Created ${this.slides.length} slides`);
            }

            startCarousel() {
                if (this.slides.length === 0) return;
                this.showSlide(0);
            }

            showSlide(index) {
                if (this.isTransitioning || this.isPaused) return;
                this.isTransitioning = true;
                this.currentSlideIndex = index;
                this.slides.forEach(slide => slide.element.classList.remove('active'));
                this.slides[index].element.classList.add('active');
                this.updateCounter();
                
                const duration = this.slides[index].config.duration || this.config.slideDuration;
                this.animateProgressBar(duration);
                
                clearTimeout(this.slideTimeout);
                this.slideTimeout = setTimeout(() => {
                    this.isTransitioning = false;
                    const nextIndex = (index + 1) % this.slides.length;
                    this.showSlide(nextIndex);
                }, duration);
            }

            animateProgressBar(duration) {
                this.progressBar.style.transition = 'none';
                this.progressBar.style.width = '0%';
                this.progressBar.offsetHeight;
                this.progressBar.style.transition = `width ${duration}ms linear`;
                this.progressBar.style.width = '100%';
            }

            updateCounter() {
                this.slideCounter.textContent = `${this.currentSlideIndex + 1} / ${this.slides.length}`;
            }

            setupClock() {
                const updateClock = () => {
                    const now = new Date();
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    document.getElementById('timeDisplay').textContent = `${hours}:${minutes}`;
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    document.getElementById('dateDisplay').textContent = now.toLocaleDateString('en-US', options);
                };
                updateClock();
                setInterval(updateClock, 1000);
            }

            setupAutoRefresh() {
                const refreshInterval = this.config.autoRefreshHours * 60 * 60 * 1000;
                setTimeout(() => location.reload(), refreshInterval);
                console.log(`Auto-refresh scheduled in ${this.config.autoRefreshHours} hours`);
            }

            setupKeyboardControls() {
                document.addEventListener('keydown', (e) => {
                    if (document.getElementById('settingsPanel').classList.contains('open')) return;
                    switch(e.key) {
                        case 'ArrowRight':
                        case 'n':
                            this.next();
                            break;
                        case 'ArrowLeft':
                        case 'p':
                            this.previous();
                            break;
                        case ' ':
                        case 'k':
                            this.isPaused ? this.resume() : this.pause();
                            break;
                    }
                });
            }

            setupWakeLock() {
                if ('wakeLock' in navigator) {
                    let wakeLock = null;
                    const requestWakeLock = async () => {
                        try {
                            wakeLock = await navigator.wakeLock.request('screen');
                            console.log('Screen wake lock acquired');
                        } catch (err) {
                            console.error('Wake lock error:', err);
                        }
                    };
                    requestWakeLock();
                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'visible') requestWakeLock();
                    });
                }
            }

            updateConfig(newConfig) {
                this.config = newConfig;
                clearTimeout(this.slideTimeout);
                this.isTransitioning = false;
                this.isPaused = false;
                this.currentSlideIndex = 0;
                this.createSlides();
                this.startCarousel();
            }

            pause() {
                this.isPaused = true;
                clearTimeout(this.slideTimeout);
                console.log('Carousel paused');
            }

            resume() {
                this.isPaused = false;
                this.isTransitioning = false;
                this.showSlide(this.currentSlideIndex);
                console.log('Carousel resumed');
            }

            next() {
                clearTimeout(this.slideTimeout);
                this.isTransitioning = false;
                this.isPaused = false;
                this.showSlide((this.currentSlideIndex + 1) % this.slides.length);
            }

            previous() {
                clearTimeout(this.slideTimeout);
                this.isTransitioning = false;
                this.isPaused = false;
                this.showSlide((this.currentSlideIndex - 1 + this.slides.length) % this.slides.length);
            }
        }

        let kiosk, settingsUI;
        
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting kiosk...');
            const savedConfig = StorageManager.load();
            const config = savedConfig || DEFAULT_CONFIG;
            kiosk = new TVKiosk(config);
            settingsUI = new SettingsUI(kiosk);
            window.kiosk = kiosk;
            console.log('Kiosk initialized.');
        });
    </script>
</body>
</html>
